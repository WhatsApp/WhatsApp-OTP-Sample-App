# WhatsApp One-Time Password (OTP) Sample Server

A sample server that generates and verifies OTP codes sent via WhatsApp Business API authentication templates.

## Overview

| Component | Language | Directory | Purpose |
|-----------|----------|-----------|---------|
| **Setup Scripts** | Python, Bash, JS | `setup/` | Create WhatsApp API configuration |
| **OTP Server** | Python | `python/` | HTTP server (Flask) |
| **OTP Server** | Node.js | `javascript/` | HTTP server (Express) |
| **OTP Server** | Go | `go/` | HTTP server (standard library) |
| **OTP Server** | Java | `java/` | HTTP server (standard library, JDK 17+) |

The four OTP server implementations are functionally identical—choose whichever language you prefer.

## Security Features

All server implementations provide these security features:

| Feature | Description |
|---------|-------------|
| **Secure OTP Generation** | Cryptographically secure random number generation |
| **OTP Hashing** | Stores SHA-256 hash of OTP—plaintext code is never persisted |
| **Constant-Time Comparison** | Prevents timing attacks during verification |
| **Max Verification Attempts** | 3 failed attempts invalidates the OTP |
| **OTP Expiry** | Codes expire after 5 minutes |
| **One-Time Use** | Code is deleted after successful verification |

## Set-up

You'll need the following to setup the OTP sample application:

1. A WhatsApp Business Account (WABA) with an associated address in Meta Business Manager
2. A System User access token with `whatsapp_business_management` and `whatsapp_business_messaging` permissions. The System User must also be added to your WABA.
3. A phone number associated with your WABA

For #3 it is recommended that you use a test phone number generated by WhatsApp to send messages free of charge. If you already have all this information, you can skip the following:

1. Follow [the instructions here](https://developers.facebook.com/docs/whatsapp/cloud-api/get-started/#set-up-developer-assets) to get started.
2. At the end of the above, in the "WhatsApp -> Getting started" tab of the App Dashboard, you'll see your WhatsApp Business Account ID and the test phone number.
3. To send messages using your test phone number, you'll need add any recipient phone numbers via the "To" field on this page.
4. Now, you'll need to add a new system user. Do so by following [this FAQ](https://www.facebook.com/business/help/503306463479099?id=2190812977867143).
5. Once you've added a System User, on [the System Users page](https://business.facebook.com/settings/system-users/), select the user, click "Add assets". Select the "Apps" tab, the app you created in Step 1, and select the "Manage app" control on the right and then "Save Changes".
6. On the same System Users page as before, select the user and click "Generate new token". Select the app you created in Step 1 and give it `whatsapp_business_management` and `whatsapp_business_messaging` permissions via the checkboxes. Copy the token to a safe place, you'll need it.
7. On the [WhatsApp Accounts](https://business.facebook.com/settings/whatsapp-business-accounts/1) page, click the "Add people" button, and give the System User "Manage phone numbers and message templates" permission.
8. Go to [Business Settings](https://business.facebook.com/settings/info) and add your business address. Note that authentication templates are not available in all regions at present.

## Running the Sample Server

### Step 1: Run a Setup Script

Once you have the three required pieces of information, run one of the setup scripts. This creates the OTP template and generates the configuration needed by all server implementations.

Choose your preferred setup script language:

#### Python (Recommended)

```bash
cd setup
pip3 install -r requirements.txt
python3 setup.py
```

#### Bash

```bash
cd setup
chmod +x setup.sh
./setup.sh
```

Requires `curl` and `jq` to be installed.

#### JavaScript (Node.js)

```bash
cd setup
npm install
node setup.js
```

At the end of script execution, you should see a `whatsapp-info.json` file in the `setup` directory.

> **Note:** If you get a `ModuleNotFoundError` with Python, run `pip3 --version`. If you get for example `(python 3.8)`, try running the script with `python3.8 setup.py` instead.

### Step 2: Run an OTP Server

Choose one of the four server implementations:

#### Python

```bash
cd python
pip3 install -r requirements.txt
python3 server.py
```

#### Node.js (JavaScript)

```bash
cd javascript
npm install
node app.js
```

#### Go

```bash
cd go
go run main.go
```

Or build and run:
```bash
go build -o otp-server && ./otp-server
```

#### Java

```bash
cd java
mvn compile exec:java
```

Or without Maven:
```bash
javac -d target src/main/java/com/whatsapp/otp/server/OtpServer.java
java -cp target com.whatsapp.otp.server.OtpServer
```

---

If successful, you should see:

```
Verified OTP template 'XXXX' with ID XXXX is approved and ready to send.
Sample app listening on port 3000
```

The server outputs logs after each API call, showing the timestamp, response status, and active OTP codes (as truncated hashes).

## Interacting with the Server

The sample Android and iOS clients are already integrated with the sample server. To test manually, use the REST API:

### Send OTP: `GET /otp/:phone_number/`

Where `:phone_number` is the phone number in international format without `+` (e.g., `15551234567`).

| Code | Description |
|------|-------------|
| 200  | OTP sent successfully |
| 500  | Error calling WhatsApp send message API |

```bash
curl -X GET http://127.0.0.1:3000/otp/15551234567/
```

### Verify OTP: `POST /otp/:phone_number/`

| Code | Message |
|------|---------|
| 200  | OK (verification successful) |
| 400  | No code provided. |
| 401  | Code has expired, please request another. |
| 401  | Incorrect code. N attempt(s) remaining. |
| 401  | Too many failed attempts, please request a new code. |
| 404  | No active code for phone # :phone_number |

```bash
curl -X POST http://127.0.0.1:3000/otp/15551234567/ \
  -d '{"code": "123456"}' \
  -H "Content-Type: application/json"
```

## Configuration

The following constants can be adjusted in each server implementation:

| Constant | Default | Description |
|----------|---------|-------------|
| `port` / `PORT` | 3000 | Server port |
| `codeLength` / `CODE_LENGTH` | 6 | Number of digits in OTP |
| `codeLifetimeInMinutes` / `CODE_LIFETIME_MINUTES` | 5 | OTP expiry time |
| `maxVerificationAttempts` / `MAX_VERIFICATION_ATTEMPTS` | 3 | Max wrong attempts before invalidation |
| `apiVersion` / `API_VERSION` | v21.0 | WhatsApp Graph API version |

Configuration files:
- **Python**: `python/server.py`
- **Node.js**: `javascript/app.js`
- **Go**: `go/main.go`
- **Java**: `java/src/main/java/com/whatsapp/otp/server/OtpServer.java`

## Technical Details

### API Version

All implementations use WhatsApp Graph API **v21.0**.

### Security Implementation by Language

| Feature | Python | Node.js | Go | Java |
|---------|--------|---------|-----|------|
| **Secure Random** | `secrets.randbelow()` | `crypto.randomInt()` | `crypto/rand` | `SecureRandom` |
| **SHA-256 Hashing** | `hashlib.sha256()` | `crypto.createHash()` | `crypto/sha256` | `MessageDigest` |
| **Constant-Time Compare** | `hmac.compare_digest()` | `crypto.timingSafeEqual()` | `crypto/subtle.ConstantTimeCompare()` | Manual XOR comparison |

### Template Payload

The server sends authentication templates with the `deterministic` language policy:

```json
{
  "language": {
    "code": "en_US",
    "policy": "deterministic"
  }
}
```

## Production Considerations

This is a sample application for demonstration purposes. For production use, consider:

1. **Use Redis or a database** instead of in-memory storage for OTP data
2. **Add rate limiting** (e.g., max 5 OTPs per phone per hour)
3. **Add HTTPS** for secure transport
4. **Store secrets securely** (use environment variables or a secrets manager instead of JSON files)
5. **Add request logging and monitoring**
6. **Deploy behind a load balancer** if scaling is needed

# WhatsApp One-Time Password (OTP) Sample Server

A Node.js/Express server that generates and verifies OTP codes sent via WhatsApp Business API authentication templates.

## Security Features

This sample server implements security best practices:

| Feature | Implementation |
|---------|---------------|
| **Secure OTP Generation** | Uses `crypto.randomInt()` for cryptographically secure random numbers |
| **OTP Hashing** | Stores SHA-256 hash of OTP — plaintext code is never persisted |
| **Constant-Time Comparison** | Uses `crypto.timingSafeEqual()` to prevent timing attacks |
| **Max Verification Attempts** | 3 failed attempts invalidates the OTP |
| **OTP Expiry** | Codes expire after 5 minutes |
| **One-Time Use** | Code is deleted after successful verification |

## Set-up

You'll need the following to setup the OTP sample application:

1. A WhatsApp Business Account (WABA) with an associated address in Meta Business Manager
2. A System User access token with `whatsapp_business_management` and `whatsapp_business_messaging` permissions. The System User must also be added to your WABA.
3. A phone number associated with your WABA

For #3 it is recommended that you use a test phone number generated by WhatsApp to send messages free of charge. If you already have all this information, you can skip the following:

1. Follow [the instructions here](https://developers.facebook.com/docs/whatsapp/cloud-api/get-started/#set-up-developer-assets) to get started.
2. At the end of the above, in the "WhatsApp -> Getting started" tab of the App Dashboard, you'll see your WhatsApp Business Account ID and the test phone number.
3. To send messages using your test phone number, you'll need add any recipient phone numbers via the "To" field on this page.
4. Now, you'll need to add a new system user. Do so by following [this FAQ](https://www.facebook.com/business/help/503306463479099?id=2190812977867143).
5. Once you've added a System User, on [the System Users page](https://business.facebook.com/settings/system-users/), select the user, click "Add assets". Select the "Apps" tab, the app you created in Step 1, and select the "Manage app" control on the right and then "Save Changes".
6. On the same System Users page as before, select the user and click "Generate new token". Select the app you created in Step 1 and give it `whatsapp_business_management` and `whatsapp_business_messaging` permissions via the checkboxes. Copy the token to a safe place, you'll need it.
7. On the [WhatsApp Accounts](https://business.facebook.com/settings/whatsapp-business-accounts/1) page, click the "Add people" button, and give the System User "Manage phone numbers and message templates" permission.
8. Go to [Business Settings](https://business.facebook.com/settings/info) and add your business address. Note that authentication templates are not available in all regions at present.

Once you have the three required pieces of information, it's time to run the setup script. This creates the OTP template for you and queries some information needed by the sample server:

1. Install Python3 (https://www.python.org/downloads/).
2. Navigate to the `setup` directory (run `cd setup/` in Terminal).
3. While in the `setup` directory, run `pip3 install -r requirements.txt`. This installs the dependencies for the setup script.
4. While in the `setup` directory, run `python3 setup.py`. At the end of script execution, you should see a `whatsapp-info.json` file in the `setup` directory. This is needed for the sample server to run.

> NOTE: If you get a `ModuleNotFoundError` when running the script, run `pip3 --version`. If you get for example `(python 3.8)`, try running the script with `python3.8 setup.py` instead as that Python installation is where the packages are.

## Running the sample server

1. Install NodeJS (https://nodejs.org/en/download/).
2. Navigate to the server directory (run `cd server/` in Terminal).
3. While in the `server` directory, run `npm install`. This installs the dependencies for the sample server.
4. While in the `server` directory, run `node app.js`. If you've followed the directions so far, you should see something like:

        username@hostname server % node app.js
        Verified OTP template 'XXXX' with ID XXXX is approved and ready to send.
        Sample app listening on port 3000

Now your sample server is ready to receive authentication requests!

The sample server outputs some helpful logs to the console after each API call, namely the timestamp, the server response code & message, and all OTP codes (as hashes) with expiration times and attempt counts.

    Current time:  2024-01-15T10:30:00.000Z
    OTP requested for phone # XXXX
    Response (200): OK
    Active codes state (hashes shown, not plaintext):
    ┌─────────────┬──────────────────────┬──────────────────────────┬──────────┐
    │   (index)   │      codeHash        │   expirationTimestamp    │ attempts │
    ├─────────────┼──────────────────────┼──────────────────────────┼──────────┤
    │    XXXX     │ 'a1b2c3d4e5f6g7h8...'│ 2024-01-15T10:35:00.000Z │    0     │
    └─────────────┴──────────────────────┴──────────────────────────┴──────────┘

## Interacting with the server

The sample Android and iOS clients we have released are already integrated with the sample server. But if you wish to test your own client with the sample server, there are two REST API calls you can make.

### Send OTP: `GET http://127.0.0.1:3000/otp/:phone_number/`

Where `:phone_number` is the phone number that should receive the OTP (in international format without the `+`, e.g., `15551234567`).

#### Responses

| Code | Description |
| ---- | ----------- |
| 200  | OTP sent successfully |
| 500  | Error calling WhatsApp send message API |

#### Example `curl` command

```bash
curl -X GET http://127.0.0.1:3000/otp/15551234567/
```

### Verify OTP: `POST http://127.0.0.1:3000/otp/:phone_number/`

Where `:phone_number` is the phone number the OTP was sent to.

#### Body

```json
{
  "code": "123456"
}
```

#### Responses

| Code | Message |
| ---- | ------- |
| 200  | OK (verification successful) |
| 400  | No code provided. |
| 401  | Code has expired, please request another. |
| 401  | Incorrect code. N attempt(s) remaining. |
| 401  | Too many failed attempts, please request a new code. |
| 404  | No active code for phone # :phone_number |

#### Example `curl` command

```bash
curl -X POST http://127.0.0.1:3000/otp/15551234567/ \
  -d '{"code": "123456"}' \
  -H "Content-Type: application/json"
```

## Configuration

The following constants can be adjusted in `app.js`:

| Constant | Default | Description |
|----------|---------|-------------|
| `port` | 3000 | Server port |
| `codeLength` | 6 | Number of digits in OTP |
| `codeLifetimeInMinutes` | 5 | OTP expiry time |
| `maxVerificationAttempts` | 3 | Max wrong attempts before invalidation |
| `apiVersion` | v21.0 | WhatsApp Graph API version |

## Technical Details

### API Version

This server uses WhatsApp Graph API **v21.0**.

### OTP Security

- **Generation**: Uses Node.js `crypto.randomInt()` for cryptographically secure random number generation
- **Storage**: Only the SHA-256 hash of the OTP is stored in memory; the plaintext code is sent to WhatsApp but never persisted
- **Verification**: Uses `crypto.timingSafeEqual()` for constant-time comparison, preventing timing attacks
- **Brute Force Protection**: After 3 failed attempts, the OTP is invalidated

### Template Payload

The server sends authentication templates with the `deterministic` language policy to ensure the exact language specified is delivered:

```json
{
  "language": {
    "code": "en_US",
    "policy": "deterministic"
  }
}
```

## Production Considerations

This is a sample application for demonstration purposes. For production use, consider:

1. **Use Redis or a database** instead of in-memory storage for OTP data
2. **Add rate limiting** (e.g., max 5 OTPs per phone per hour)
3. **Add HTTPS** for secure transport
4. **Store secrets securely** (use environment variables or a secrets manager instead of JSON files)
5. **Add request logging and monitoring**
6. **Deploy behind a load balancer** if scaling is needed
